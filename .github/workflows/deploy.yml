name: Deploy

on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Deployment environment"
                required: true
                default: "production"
                type: choice
                options:
                    - production
                    - staging
    workflow_run:
        workflows: ["Docker Build and Push"]
        types:
            - completed
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        environment:
            name: ${{ inputs.environment || 'production' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # ========================================
            # DEPLOYMENT STEPS - CUSTOMIZE FOR YOUR PLATFORM
            # ========================================

            # Example for Render.com
            # - name: Deploy to Render
            #   run: |
            #     curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

            # Example for Railway.app
            # - name: Deploy to Railway
            #   run: |
            #     curl -X POST "${{ secrets.RAILWAY_WEBHOOK_URL }}"

            # Example for DigitalOcean App Platform
            # - name: Deploy to DigitalOcean
            #   uses: digitalocean/app_action@v1
            #   with:
            #     app_name: tennis-tournament
            #     token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            # Example for AWS ECS
            # - name: Deploy to AWS ECS
            #   uses: aws-actions/amazon-ecs-deploy-task-definition@v1
            #   with:
            #     task-definition: task-definition.json
            #     service: tennis-tournament-service
            #     cluster: tennis-tournament-cluster

            # Generic Docker deployment via SSH
            # - name: Deploy via SSH
            #   uses: appleboy/ssh-action@v1.0.0
            #   with:
            #     host: ${{ secrets.DEPLOY_HOST }}
            #     username: ${{ secrets.DEPLOY_USER }}
            #     key: ${{ secrets.DEPLOY_SSH_KEY }}
            #     script: |
            #       docker pull ghcr.io/${{ github.repository }}:latest
            #       docker stop tennis-tournament || true
            #       docker rm tennis-tournament || true
            #       docker run -d \
            #         --name tennis-tournament \
            #         -p 3000:3000 \
            #         --env-file /path/to/.env \
            #         ghcr.io/${{ github.repository }}:latest

            - name: Trigger Render Deployment
              id: deploy
              run: |
                  echo "ðŸš€ Triggering Render deployment..."
                  RESPONSE=$(curl -s -w "\n%{http_code}" "${{ secrets.RENDER_DEPLOY_HOOK }}")
                  HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

                  if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
                    echo "âœ… Deployment triggered successfully (HTTP $HTTP_CODE)"
                    echo "status=success" >> $GITHUB_OUTPUT
                  else
                    echo "âŒ Deployment trigger failed (HTTP $HTTP_CODE)"
                    echo "status=failed" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: Deployment Summary
              if: always()
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Environment**: ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Image**: \`ghcr.io/${{ github.repository }}:latest\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Status**: ${{ steps.deploy.outputs.status || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
                  echo "1. Monitor Render dashboard for deployment progress" >> $GITHUB_STEP_SUMMARY
                  echo "2. Check application logs for any errors" >> $GITHUB_STEP_SUMMARY
                  echo "3. Verify database migrations completed successfully" >> $GITHUB_STEP_SUMMARY
